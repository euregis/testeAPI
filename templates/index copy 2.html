<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Workflow Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.5rem;
            margin: 0.3rem 0;
        }

        .step {
            border: 1px solid #ccc;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .step:hover {
            background-color: #f9f9f9;
            cursor: pointer;
        }

        .btn {
            padding: 0.5rem 1rem;
            margin: 0.3rem;
            cursor: pointer;
        }

        .flex {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .validation {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .validation input,
        .validation select {
            flex: 1;
        }

        .validation button {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
        }

        .validation button:hover {
            background-color: #d32f2f;
        }
    </style>
</head>

<body>
    <h1>Workflow Editor</h1>

    <section>
        <h2>Global</h2>
        <input id="workflowName" placeholder="Workflow Name">
        <textarea id="globalInput" placeholder='{"userId": "123", "token": "abc"}'></textarea>
        <button class="btn" onclick="updateWorkflow()">Update Workflow</button>
    </section>

    <hr>

    <section>
        <h2>Add / Edit Step</h2>
        <input id="stepName" placeholder="Step Name">
        <select id="stepMethod">
            <option value="GET" selected>GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
            <option value="PATCH">PATCH</option>
        </select>
        <input id="stepUrl" placeholder="URL">
        <textarea id="stepHeaders" placeholder='{"Authorization": "Bearer {token}"}'></textarea>
        <textarea id="stepBody" placeholder='{"key": "value"}'></textarea>
        <!-- <input id="stepDepends" placeholder="Depends On (comma-separated)"> -->
        <select id="stepDepends">
            <option value="">No dependency</option>
        </select>
        <h3>Validations</h3>
        <div id="validations"></div>
        <button class="btn" onclick="addValidation()">Add Validation</button>

        <div class="flex">
            <button class="btn" onclick="addStep()">Add Step</button>
            <button class="btn" onclick="updateStep()">Update Step</button>
            <button class="btn" onclick="clearForm()">Reset Form</button>
        </div>
    </section>

    <hr>

    <section>
        <h2>Steps</h2>
        <div id="stepsList"></div>
    </section>

    <script>
        let currentSteps = {};

        async function loadWorkflow() {
            const res = await fetch("/workflow");
            const data = await res.json();
            document.getElementById("workflowName").value = data.workflowName;
            document.getElementById("globalInput").value = JSON.stringify(data.global.input, null, 2);
            currentSteps = data.steps || {};
            renderSteps();
        }

        function renderSteps() {
            const stepsList = document.getElementById("stepsList");
            stepsList.innerHTML = "";
            for (let [name, step] of Object.entries(currentSteps)) {
                const div = document.createElement("div");
                div.className = "step";
                div.innerHTML = `
          <strong>${name}</strong>
          <pre>${JSON.stringify(step, null, 2)}</pre>
          <button class="btn" onclick="deleteStep('${name}')">Delete</button>
        `;
                div.onclick = () => fillFormFromStep(name, step);
                stepsList.appendChild(div);
            }
            updateDependsOnOptions();
        }

        function fillFormFromStep(name, step) {
            document.getElementById("stepName").value = name;
            document.getElementById("stepMethod").value = step.method;
            document.getElementById("stepUrl").value = step.url;
            document.getElementById("stepHeaders").value = JSON.stringify(step.headers || {}, null, 2);
            document.getElementById("stepBody").value = JSON.stringify(step.body || {}, null, 2);
            document.getElementById("stepDepends").value = step.dependsOn || "";
            document.getElementById("validations").innerHTML = "";
            (step.validations || []).forEach(addValidationFromData);
        }

        function clearForm() {
            document.getElementById("stepName").value = "";
            document.getElementById("stepMethod").value = "GET";
            document.getElementById("stepUrl").value = "";
            document.getElementById("stepHeaders").value = "";
            document.getElementById("stepBody").value = "";
            document.getElementById("stepDepends").value = "";
            document.getElementById("validations").innerHTML = "";
        }

        async function updateWorkflow() {
            await fetch("/workflow", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    workflowName: document.getElementById("workflowName").value,
                    global: {
                        input: JSON.parse(document.getElementById("globalInput").value)
                    }
                })
            });
            await loadWorkflow();
        }

        async function addStep() {
            await fetch("/steps", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(readStepForm())
            });
            clearForm();
            await loadWorkflow();
        }

        async function updateStep() {
            const name = document.getElementById("stepName").value;
            await fetch(`/steps/${name}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(readStepForm())
            });
            clearForm();
            await loadWorkflow();
        }

        async function deleteStep(name) {
            await fetch(`/steps/${name}`, { method: "DELETE" });
            await loadWorkflow();
        }

        function readStepForm() {
            // updateDependsOnOptions();
            const depends = document.getElementById("stepDepends").value;
            return {
                name: document.getElementById("stepName").value,
                method: document.getElementById("stepMethod").value,
                url: document.getElementById("stepUrl").value,
                headers: JSON.parse(document.getElementById("stepHeaders").value || "{}"),
                body: JSON.parse(document.getElementById("stepBody").value || "{}"),
                // dependsOn: document.getElementById("stepDepends").value.split(",").map(s => s.trim()).filter(Boolean),
                dependsOn: depends || "",
                validations: getValidations()
            };
        }
        function updateDependsOnOptions() {
            const select = document.getElementById("stepDepends");
            const currentStepName = document.getElementById("stepName").value;
            const selected = select.value;

            select.innerHTML = '<option value="">No dependency</option>';
            Object.keys(currentSteps).forEach(name => {
                if (name !== currentStepName) {
                    const opt = document.createElement("option");
                    opt.value = name;
                    opt.textContent = name;
                    if (name === selected) opt.selected = true;
                    select.appendChild(opt);
                }
            });
        }

        function getValidations() {
            const validations = [];
            document.querySelectorAll("#validations .validation").forEach(el => {
                const target = el.querySelector(".val-target").value;
                const operator = el.querySelector(".val-operator").value;
                const value = el.querySelector(".val-value").value;
                const v = { target, operator };
                if (operator !== "notEmpty") v.value = isNaN(value) ? value : Number(value);
                validations.push(v);
            });
            return validations;
        }

        function addValidation() {
            addValidationFromData({ target: "", operator: "equals", value: "" });
        }

        function addValidationFromData({ target, operator, value }) {
            const div = document.createElement("div");
            div.className = "validation";
            div.innerHTML = `
        <input placeholder="Target (e.g. body.valor)" class="val-target" value="${target || ""}">
        <select class="val-operator">
          <option value="equals">equals</option>
          <option value="notEquals">notEquals</option>
          <option value="contains">contains</option>
          <option value="notEmpty">notEmpty</option>
          <option value="greaterThan">greaterThan</option>
          <option value="lessThan">lessThan</option>
        </select>
        <input placeholder="Value (if needed)" class="val-value" value="${value ?? ""}">
        <button onclick="this.parentElement.remove()">âœ–</button>
      `;
            div.querySelector(".val-operator").value = operator;
            document.getElementById("validations").appendChild(div);
        }

        loadWorkflow();
    </script>
</body>

</html>