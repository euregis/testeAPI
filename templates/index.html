<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Workflow Editor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --danger: #dc3545;
            --danger-dark: #a71d2a;
            --bg-light: #23272f;
            --bg-panel: #282c34;
            --border: #343a40;
            --radius: 8px;
            --text: #e9ecef;
            --text-muted: #adb5bd;
        }

        body {
            font-family: 'JetBrains Mono', monospace, 'Roboto', sans-serif;
            background: var(--bg-light);
            margin: 0;
            padding: 0;
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        .main-layout {
            display: flex;
            height: calc(100vh - 10px);
            margin-top: 5px;
        }

        .sidebar-top-row {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .sidebar,
        .right-panel {
            background: var(--bg-panel);
            padding: 1rem 0.5rem;
            overflow-y: auto;
            min-width: 320px;
        }

        .sidebar {
            width: 240px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1 1 0;
        }

        .right-panel {
            flex: 1 1 0;
            padding: 1.2rem 1.2rem;
        }

        .sidebar h2 {
            font-size: 1.1rem;
            color: var(--primary-dark);
            margin: 0;
        }

        .sidebar select {
            margin-bottom: 0.5rem;
        }

        .sidebar .btn {
            width: 100%;
            margin: 0.2rem 0;
        }

        .center-panel {
            flex: 2 1 0;
            background: var(--bg-light);
            padding: 1.2rem 1.5rem;
            overflow-y: auto;
            border-right: 1px solid var(--border);
        }

        .steps-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .step {
            border: 1px solid var(--border);
            padding: 0.7rem 1rem;
            border-radius: var(--radius);
            background-color: #23272f;
            margin-bottom: 0.7rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .step.selected,
        .step:hover {
            background: #31363f;
            border-color: var(--primary);
        }

        .step strong {
            color: var(--primary);
        }

        .step-details {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .btn,
        .btn-secondary,
        .btn-danger {
            padding: 0.4rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.95rem;
            font-family: 'JetBrains Mono', monospace, 'Roboto', sans-serif;
        }

        .btn {
            background-color: var(--primary);
            color: white;
        }

        .btn:hover {
            background-color: var(--primary-dark);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
        }

        .btn-secondary {
            background: #444950;
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #3a3f46;
        }

        .btn-group {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            margin-top: 0.8rem;
        }

        .form-section {
            margin-bottom: 0.5rem;
        }

        .form-section label {
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 0.2rem;
            display: block;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.36rem 0.5rem;
            margin-top: 0.08rem;
            margin-bottom: 0.13rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-sizing: border-box;
            font-size: 0.95rem;
            background-color: #181b20;
            color: var(--text);
        }

        input[type="checkbox" i] {
            width: auto;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            overflow-y: hidden;
            height: auto;
        }

        .validation {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .validation input,
        .validation select {
            flex: 1;
        }

        hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 0.5rem 0;
        }

        .failed-validation {
            color: var(--danger);
        }

        .env-row {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .env-row label {
            margin: 0;
            font-size: 0.97rem;
            color: var(--text-muted);
            font-weight: normal;
        }

        .form-section.inline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section.inline label {
            margin-bottom: 0;
            display: inline;
        }

        @media (max-width: 1100px) {
            .main-layout {
                flex-direction: column;
            }

            .sidebar,
            .right-panel {
                width: 100vw;
                min-width: unset;
                border: none;
            }

            .center-panel {
                border: none;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }

            .sidebar,
            .right-panel,
            .center-panel {
                width: 100%;
                min-width: unset;
                padding: 0.7rem;
                box-sizing: border-box;
            }
        }
    </style>
</head>

<body>
    <!-- <div class="topbar">
        <span class="topbar-title">Workflow Editor</span>
        <div>
            <label style="margin-right:0.5rem;">Ambiente:</label>
            <select id="envSelector"></select>
        </div>
    </div> -->
    <div class="main-layout">
        <aside class="sidebar">
            <div class="sidebar-top-row">
                <select id="workflowSelector" onchange="loadSelectedWorkflow()">
                    <option value="">-- select workflow --</option>
                </select>
                <button class="icon-btn" title="New Workflow" onclick="createNewWorkflow()">
                    <span aria-label="New Workflow" title="Novo workflow">➕</span>
                </button>
                <button id="showGlobalConfig" class="icon-btn" title="Show Global Config" onclick="showGlobalConfig()">
                    <span aria-label="Show Global Config" title="Configuração global">⚙️</span>
                </button>
            </div>
            <div class="env-row">
                <label>ambiente:</label>
                <select id="envSelector"></select>
            </div>
            <div id="globalConfigPanel" style="display:none;">
                <div class="form-section">
                    <label for="workflowName">Workflow Name</label>
                    <input id="workflowName" placeholder="Workflow Name" />
                </div>
                <div class="form-section">
                    <label for="globalInput">Global Input</label>
                    <textarea id="globalInput" oninput="autoResize(this)"
                        placeholder='{"userId": "123", "token": "abc"}'></textarea>
                </div>
                <div class="form-section inline">
                    <label for="useProxyCheckbox">
                        Use proxy
                    </label>
                    <input type="checkbox" id="useProxyCheckbox" />
                </div>
                <button class="btn" onclick="updateWorkflow()">Save Workflow</button>
                <hr>
            </div>
            <hr>
            <div id="stepFormPanel">
                <div class="form-section">
                    <label for="stepName">Step Name</label>
                    <input id="stepName" placeholder="Step Name" />
                </div>
                <div class="form-section">
                    <label for="stepMethod">Method</label>
                    <select id="stepMethod">
                        <option value="GET" selected>GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                    </select>
                </div>
                <div class="form-section">
                    <label for="stepDepends">Depends On</label>
                    <select id="stepDepends">
                        <option value="">No dependency</option>
                    </select>
                </div>
                <div class="form-section">
                    <label for="stepUrl">URL</label>
                    <input id="stepUrl" placeholder="URL" />
                </div>
                <div class="form-section">
                    <label for="stepHeaders">Headers</label>
                    <textarea id="stepHeaders" oninput="autoResize(this)"
                        placeholder='{"Authorization": "Bearer {token}"}'></textarea>
                </div>
                <div class="form-section">
                    <label for="stepBody">Body</label>
                    <textarea id="stepBody" oninput="autoResize(this)" placeholder='{"key": "value"}'></textarea>
                </div>
                <div class="form-section">
                    <h3 style="margin-bottom:0.5rem;">Validations</h3>
                    <div id="validations"></div>
                    <button class="btn btn-secondary" type="button" onclick="addValidation()">+ Add Validation</button>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="addStep()">Add Step</button>
                    <button class="btn" onclick="updateStep()">Update Step</button>
                    <button class="btn btn-danger" onclick="clearForm()">Reset</button>
                </div>
            </div>
        </aside>
        <section class="center-panel">
            <h2>Steps</h2>
            <ul id="stepsList" class="steps-list"></ul>
        </section>
        <!-- <aside class="right-panel">
            
        </aside> -->
    </div>
    <script>
        let currentSteps = {};

        async function loadEnvironments() {
            const res = await fetch("/environments");
            const envs = await res.json();
            const envSelector = document.getElementById("envSelector");
            envSelector.innerHTML = "";
            envs.forEach(env => {
                const opt = document.createElement("option");
                opt.value = env.name;
                opt.textContent = env.name//.charAt(0).toUpperCase() + env.name.slice(1);
                envSelector.appendChild(opt);
            });
        }

        async function loadWorkflows() {
            const res = await fetch("/workflows");
            const workflows = await res.json();
            const selector = document.getElementById("workflowSelector");
            selector.innerHTML = '<option value="">-- Select Workflow --</option>';
            workflows.forEach(name => {
                const option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                selector.appendChild(option);
            });
        }

        function loadSelectedWorkflow() {
            const selectedWorkflow = document.getElementById("workflowSelector").value;
            if (selectedWorkflow) {
                loadWorkflow(selectedWorkflow);
            }
        }

        async function createNewWorkflow() {
            const workflowName = prompt("Enter new workflow name:");
            if (workflowName) {
                await fetch(`/workflow/${workflowName}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ workflowName, global: {} })
                });
                await loadWorkflows();
                document.getElementById("workflowSelector").value = workflowName;
                document.querySelectorAll('textarea').forEach(t => autoResize(t));
                loadWorkflow(workflowName);
            }
        }

        async function loadWorkflow(name) {
            const res = await fetch(`/workflow/${name}`);
            const data = await res.json();
            document.getElementById("workflowName").value = data.workflowName;
            document.getElementById("globalInput").value = JSON.stringify(data.global, null, 2);
            // Set proxy checkbox if present, default false
            document.getElementById("useProxyCheckbox").checked = !!data.useProxy;
            currentSteps = data.steps || {};

            document.querySelectorAll('textarea').forEach(t => autoResize(t));
            renderSteps();
        }

        async function updateWorkflow() {
            const workflowName = document.getElementById("workflowSelector").value;
            await fetch(`/workflow/${workflowName}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    workflowName: document.getElementById("workflowName").value,
                    global: JSON.parse(document.getElementById("globalInput").value),
                    useProxy: document.getElementById("useProxyCheckbox").checked
                })
            });
            document.querySelectorAll('textarea').forEach(t => autoResize(t));
            await loadWorkflow(workflowName);
        }

        function executeStep(name) {
            const workflowName = document.getElementById("workflowSelector").value;
            const env = document.getElementById("envSelector").value;
            // Passar o valor do checkbox para o backend
            const useProxy = document.getElementById("useProxyCheckbox").checked;
            fetch(`workflow/${workflowName}/steps/${name}/execute`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ env, useProxy })
            })
                .then(res => res.json())
                .then(data => {
                    const stepDiv = document.querySelector(`.step[data-name='${name}']`);
                    let resultDiv = stepDiv.querySelector(".step-result");

                    if (!resultDiv) {
                        resultDiv = document.createElement("div");
                        resultDiv.className = "step-result";
                        resultDiv.style.display = "none";
                        stepDiv.appendChild(resultDiv);

                        const toggleButton = document.createElement("button");
                        toggleButton.textContent = "Show Result";
                        toggleButton.className = "btn btn-secondary";
                        toggleButton.onclick = (e) => {
                            e.stopPropagation();
                            const isHidden = resultDiv.style.display === "none";
                            resultDiv.style.display = isHidden ? "block" : "none";
                            toggleButton.textContent = isHidden ? "Hide Result" : "Show Result";
                        };
                        stepDiv.appendChild(toggleButton);
                    }

                    const successValidations = data.success_validations.map(v => `<li>${v}</li>`).join("");
                    const failedValidations = data.failed_validations.map(v => `<li>${v}</li>`).join("");

                    resultDiv.innerHTML = `
                        <h4>Execution Result for Step: ${name}</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;

                    let validationsDiv = stepDiv.querySelector(".validations-result");
                    if (!validationsDiv) {
                        validationsDiv = document.createElement("div");
                        validationsDiv.className = "validations-result";
                        validationsDiv.style.marginTop = "1rem";
                        stepDiv.appendChild(validationsDiv);
                    }

                    validationsDiv.innerHTML = `
                        <h5>Successful Validations</h5>
                        <ul>${successValidations}</ul>
                        <h5 class="failed-validation">Failed Validations</h5>
                        <ul>${failedValidations}</ul>
                    `;
                })
                .catch(err => alert("Error executing step: " + err));
        }

        function renderSteps() {
            const stepsList = document.getElementById("stepsList");
            stepsList.innerHTML = "";
            for (let [name, step] of Object.entries(currentSteps)) {
                const li = document.createElement("li");
                li.className = "step";
                li.setAttribute("data-name", name);

                const stepName = document.createElement("strong");
                stepName.textContent = name;
                li.appendChild(stepName);

                const stepDetails = document.createElement("div");
                stepDetails.className = "step-details";
                stepDetails.style.display = "none";
                stepDetails.innerHTML = `<pre>${JSON.stringify(step, null, 2)}</pre>`;
                li.appendChild(stepDetails);

                const toggleButton = document.createElement("button");
                toggleButton.textContent = "Show Details";
                toggleButton.className = "btn btn-secondary";
                toggleButton.onclick = (e) => {
                    e.stopPropagation();
                    const isHidden = stepDetails.style.display === "none";
                    stepDetails.style.display = isHidden ? "block" : "none";
                    toggleButton.textContent = isHidden ? "Hide Details" : "Show Details";
                };

                const buttonContainer = document.createElement("div");
                buttonContainer.style.display = "flex";
                buttonContainer.style.gap = "0.5rem";
                buttonContainer.style.marginTop = "0.5rem";

                buttonContainer.appendChild(toggleButton);
                buttonContainer.insertAdjacentHTML("beforeend", `
                    <button class="btn" onclick="event.stopPropagation();deleteStep('${name}')">Delete</button>
                    <button class="btn" onclick="event.stopPropagation();executeStep('${name}')">Execute</button>
                `);

                li.appendChild(buttonContainer);
                li.onclick = () => fillFormFromStep(name, step);
                stepsList.appendChild(li);
            }
            updateDependsOnOptions();
        }

        function fillFormFromStep(name, step) {
            document.getElementById("stepName").value = name;
            document.getElementById("stepMethod").value = step.method;
            document.getElementById("stepUrl").value = step.url;
            document.getElementById("stepHeaders").value = JSON.stringify(step.headers || {}, null, 2);
            document.getElementById("stepBody").value = JSON.stringify(step.body || {}, null, 2);
            document.getElementById("stepDepends").value = step.dependsOn || "";
            document.getElementById("validations").innerHTML = "";
            (step.validations || []).forEach(addValidationFromData);

            document.querySelectorAll('textarea').forEach(t => autoResize(t));
        }

        function clearForm() {
            document.getElementById("stepName").value = "";
            document.getElementById("stepMethod").value = "GET";
            document.getElementById("stepUrl").value = "";
            document.getElementById("stepHeaders").value = "";
            document.getElementById("stepBody").value = "";
            document.getElementById("stepDepends").value = "";
            document.getElementById("validations").innerHTML = "";
        }

        async function updateWorkflow() {
            const workflowName = document.getElementById("workflowSelector").value;
            await fetch(`/workflow/${workflowName}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    workflowName: document.getElementById("workflowName").value,
                    global: JSON.parse(document.getElementById("globalInput").value),
                    useProxy: document.getElementById("useProxyCheckbox").checked
                })
            });
            document.querySelectorAll('textarea').forEach(t => autoResize(t));
            await loadWorkflow(workflowName);
        }

        async function addStep() {
            const workflowName = document.getElementById("workflowSelector").value;
            await fetch(`/workflow/${workflowName}/steps`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(readStepForm())
            });
            clearForm();
            await loadWorkflow(workflowName);
        }

        async function updateStep() {
            const workflowName = document.getElementById("workflowSelector").value;
            const name = document.getElementById("stepName").value;
            if (!name) {
                alert("Step Name is required to update a step.");
                return;
            }
            await fetch(`/workflow/${workflowName}/steps/${name}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(readStepForm())
            }).then(response => {
                if (!response.ok) {
                    throw new Error("Failed to update step. Please check the input data.");
                }
            }).catch(error => {
                alert(error.message);
            });
            clearForm();
            await loadWorkflow(workflowName);
        }

        async function deleteStep(name) {
            const workflowName = document.getElementById("workflowSelector").value;
            await fetch(`/workflow/${workflowName}/steps/${name}`, { method: "DELETE" });
            await loadWorkflow(workflowName);
        }

        function readStepForm() {
            const depends = document.getElementById("stepDepends").value;
            return {
                name: document.getElementById("stepName").value,
                method: document.getElementById("stepMethod").value,
                url: document.getElementById("stepUrl").value,
                headers: JSON.parse(document.getElementById("stepHeaders").value || "{}"),
                body: JSON.parse(document.getElementById("stepBody").value || "{}"),
                dependsOn: depends || "",
                validations: getValidations()
            };
        }
        function updateDependsOnOptions() {
            const select = document.getElementById("stepDepends");
            const currentStepName = document.getElementById("stepName").value;
            const selected = select.value;

            select.innerHTML = '<option value="">No dependency</option>';
            Object.keys(currentSteps).forEach(name => {
                if (name !== currentStepName) {
                    const opt = document.createElement("option");
                    opt.value = name;
                    opt.textContent = name;
                    if (name === selected) opt.selected = true;
                    select.appendChild(opt);
                }
            });
        }

        function getValidations() {
            const validations = [];
            document.querySelectorAll("#validations .validation").forEach(el => {
                const target = el.querySelector(".val-target").value;
                const operator = el.querySelector(".val-operator").value;
                const value = el.querySelector(".val-value").value;
                const v = { target, operator };
                if (operator !== "notEmpty") v.value = isNaN(value) ? value : Number(value);
                validations.push(v);
            });
            return validations;
        }

        function addValidation() {
            addValidationFromData({ target: "", operator: "equals", value: "" });
        }

        function addValidationFromData({ target, operator, value }) {
            const div = document.createElement("div");
            div.className = "validation";
            div.innerHTML = `
        <input placeholder="Target (e.g. body.valor)" class="val-target" value="${target || ""}">
        <select class="val-operator">
          <option value="equals">equals</option>
          <option value="notEquals">notEquals</option>
          <option value="contains">contains</option>
          <option value="notEmpty">notEmpty</option>
          <option value="greaterThan">greaterThan</option>
          <option value="lessThan">lessThan</option>
          <option value="minLength">minLength</option>
          <option value="maxLength">maxLength</option>
          <option value="isType">isType</option>
          <option value="matchesRegex">matchesRegex</option>
        </select>
        <input placeholder="Value (if needed)" class="val-value" value="${value ?? ""}">
        <button type="button" onclick="this.parentElement.remove()">✖</button>
      `;
            div.querySelector(".val-operator").value = operator;
            document.getElementById("validations").appendChild(div);
        }

        function showGlobalConfig() {
            const globalConfigPanel = document.getElementById("globalConfigPanel");
            const stepFormPanel = document.getElementById("stepFormPanel");
            const toggleGlobalConfigButton = document.getElementById("showGlobalConfig");

            const isHidden = globalConfigPanel.style.display === "none";
            globalConfigPanel.style.display = isHidden ? "block" : "none";
            stepFormPanel.style.display = isHidden ? "none" : "block";
            toggleGlobalConfigButton.textContent = isHidden ? "👣" : "⚙️";

            document.querySelectorAll('textarea').forEach(t => autoResize(t));
        }
        function autoResize(textarea) {
            textarea.style.height = 'auto'; // Reseta a altura
            textarea.style.height = textarea.scrollHeight + 'px'; // Ajusta para o conteúdo
        }
        loadEnvironments();
        loadWorkflows();
    </script>
</body>

</html>