<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Workflow Editor</title>
  <style>
    body {
      font-family: Arial;
      margin: 2rem;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 0.5rem;
      margin: 0.3rem 0;
    }

    .step {
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      margin: 0.3rem;
      cursor: pointer;
    }

    .flex {
      display: flex;
      gap: 1rem;
    }
  </style>
</head>

<body>
  <h1>Workflow Editor</h1>

  <section>
    <h2>Global</h2>
    <input id="workflowName" placeholder="Workflow Name">
    <textarea id="globalInput" placeholder='{"userId": "123", "token": "abc"}'></textarea>
    <button class="btn" onclick="updateWorkflow()">Update Workflow</button>
  </section>

  <hr>

  <section>
    <h2>Add / Update Step</h2>
    <input id="stepName" placeholder="Step Name">
    <select id="stepMethod">
      <option value="GET" selected>GET</option>
      <option value="POST">POST</option>
      <option value="PUT">PUT</option>
      <option value="DELETE">DELETE</option>
      <option value="PATCH">PATCH</option>
    </select>
    <input id="stepUrl" placeholder="URL">
    <textarea id="stepHeaders" placeholder='{"Authorization": "Bearer {token}"}'></textarea>
    <textarea id="stepBody" placeholder='{"key": "value"}'></textarea>
    <input id="stepDepends" placeholder="Depends On (comma-separated)">
    <h3>Validations</h3>
    <div id="validations">
      <div class="validation">
        <input placeholder="Target (e.g. body.valor)" class="val-target">
        <select class="val-operator">
          <option value="equals">equals</option>
          <option value="notEquals">notEquals</option>
          <option value="contains">contains</option>
          <option value="notEmpty">notEmpty</option>
          <option value="greaterThan">greaterThan</option>
          <option value="lessThan">lessThan</option>
        </select>
        <input placeholder="Value (if needed)" class="val-value">
      </div>
    </div>
    <button onclick="addValidation()">Add Validation</button>
    <div class="flex">
      <button class="btn" onclick="addStep()">Add Step</button>
      <button class="btn" onclick="updateStep()">Update Step</button>
    </div>
  </section>

  <hr>

  <section>
    <h2>Steps</h2>
    <div id="stepsList"></div>
  </section>

  <script>
    async function loadWorkflow() {
      const res = await fetch("/workflow");
      const data = await res.json();
      document.getElementById("workflowName").value = data.workflowName;
      document.getElementById("globalInput").value = JSON.stringify(data.global.input, null, 2);
      const stepsList = document.getElementById("stepsList");
      stepsList.innerHTML = "";
      for (let [name, step] of Object.entries(data.steps)) {
        stepsList.innerHTML += `
          <div class="step">
            <strong>${name}</strong>
            <pre>${JSON.stringify(step, null, 2)}</pre>
            <button class="btn" onclick="deleteStep('${name}')">Delete</button>
          </div>
        `;
      }
    }

    async function updateWorkflow() {
      const res = await fetch("/workflow", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workflowName: document.getElementById("workflowName").value,
          global: {
            input: JSON.parse(document.getElementById("globalInput").value)
          }
        })
      });
      await loadWorkflow();
    }

    async function addStep() {
      const res = await fetch("/steps", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(readStepForm())
      });
      await loadWorkflow();
    }

    async function updateStep() {
      const name = document.getElementById("stepName").value;
      const res = await fetch(`/steps/${name}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(readStepForm())
      });
      await loadWorkflow();
    }

    async function deleteStep(name) {
      const res = await fetch(`/steps/${name}`, { method: "DELETE" });
      await loadWorkflow();
    }

    function readStepForm() {
      return {
        name: document.getElementById("stepName").value,
        method: document.getElementById("stepMethod").value,
        url: document.getElementById("stepUrl").value,
        headers: JSON.parse(document.getElementById("stepHeaders").value || "{}"),
        body: JSON.parse(document.getElementById("stepBody").value || "{}"),
        dependsOn: document.getElementById("stepDepends").value.split(",").map(s => s.trim()).filter(s => s),
        validations: getValidations()
      };
    }

    function getValidations() {
      const validations = [];
      document.querySelectorAll("#validations .validation").forEach(el => {
        const target = el.querySelector(".val-target").value;
        const operator = el.querySelector(".val-operator").value;
        const value = el.querySelector(".val-value").value;

        const v = { target, operator };
        if (operator !== "notEmpty") v.value = isNaN(value) ? value : Number(value);
        validations.push(v);
      });
      return validations;
    }
    function addValidation() {
      const div = document.createElement("div");
      div.className = "validation";
      div.innerHTML = `
        <input placeholder="Target (e.g. body.valor)" class="val-target">
        <select class="val-operator">
          <option value="equals">equals</option>
          <option value="notEquals">notEquals</option>
          <option value="contains">contains</option>
          <option value="notEmpty">notEmpty</option>
          <option value="greaterThan">greaterThan</option>
          <option value="lessThan">lessThan</option>
        </select>
        <input placeholder="Value (if needed)" class="val-value">
      `;
      document.getElementById("validations").appendChild(div);
    }
    loadWorkflow();
  </script>
</body>

</html>